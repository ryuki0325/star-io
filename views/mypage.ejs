<% title = 'マイページ' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">マイページ</h2>

  <!-- ユーザー情報 -->
  <div class="card bg-dark border border-info mb-4 p-3">
    <p class="mb-2 text-white">📧 メール: <span class="fw-bold text-white"><%= user.email %></span></p>
    <p class="mb-0 text-white">💰 残高: <span class="fw-bold text-success"><%= Number(user.balance).toFixed(2) %> 円</span></p>
  </div>

  <!-- 🔑 パスワード変更フォーム -->
  <div class="card bg-dark text-light mb-4">
    <div class="card-body">
      <h4 class="card-title">🔑 パスワード変更</h4>

      <% if (pwdError) { %>
        <div class="alert alert-danger"><%= pwdError %></div>
      <% } %>

      <% if (pwdSuccess) { %>
        <div class="alert alert-success"><%= pwdSuccess %></div>
      <% } %>

      <form action="/change-password" method="POST">
        <div class="mb-3">
          <label class="form-label">現在のパスワード</label>
          <input type="password" name="currentPassword" class="form-control bg-dark text-light border-info" required>
        </div>
        <div class="mb-3">
          <label class="form-label">新しいパスワード</label>
          <input type="password" name="newPassword" class="form-control bg-dark text-light border-info" required>
        </div>
        <div class="mb-3">
          <label class="form-label">新しいパスワード（再入力）</label>
          <input type="password" name="confirmPassword" class="form-control bg-dark text-light border-info" required>
        </div>
        <button type="submit" class="btn btn-info w-100">変更する</button>
      </form>
    </div>
  </div>

  <!-- 📝 注文履歴 -->
  <h3 class="mb-3 text-white">📝 注文履歴</h3>

  <% if (!orders || orders.length === 0) { %>
    <p class="text-center text-secondary">まだ注文履歴がありません。</p>
  <% } else { %>
    <div class="d-flex flex-column gap-3">
      <% orders.forEach(order => { %>
        <div class="order-card border border-info rounded p-3 shadow-sm">
          
          <!-- サービスID & 日時 -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-info text-dark fw-bold px-3 py-2">
              サービスID: <%= order.service_id %>
            </span>
            <span class="badge bg-dark text-white">
              📅 <%= new Date(order.created_at).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) %>
            </span>
          </div>

          <!-- サービス名 -->
          <h5 class="text-white mb-2" style="word-break: break-word;">
            ✨ <%= order.service_name %>
          </h5>

          <!-- サービス詳細 -->
          <p class="mb-1 text-white">
            🔗 <a href="<%= order.link %>" target="_blank" class="text-decoration-underline text-info">リンク</a>
          </p>
          <p class="mb-1 text-white">
            📦 数量: <span class="fw-bold text-warning"><%= order.quantity %></span>
          </p>
          <p class="mb-1 text-white">
            💰 金額: <span class="fw-bold text-success"><%= Number(order.price_jpy).toFixed(2) %> 円</span>
          </p>

          <!-- ステータス -->
          <p class="mb-0 text-white">
            📌 ステータス: 
            <% 
              let jpStatus = "不明";
              if (order.status === "completed") jpStatus = "完了";
              else if (order.status === "pending") jpStatus = "保留中";
              else if (order.status === "inprogress") jpStatus = "進行中";
             else if (order.status === "processing") jpStatus = "処理中";
            %>
            <span class="badge 
              <%= order.status === 'completed' 
                  ? 'bg-success' 
                  : order.status === 'pending' 
                    ? 'bg-warning text-dark' 
                    : order.status === 'inprogress' 
                      ? 'bg-info text-dark' 
                      : 'bg-secondary' %>">
              <%= jpStatus %>
            </span>
          </p>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<style>
  .order-card {
    background: #111; /* 黒背景 */
    transition: transform 0.2s, box-shadow 0.2s;
    color: white; /* カード内の文字を白に */
  }
  .order-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 15px rgba(13, 202, 240, 0.6);
  }

/* ===== スマホ向けマイページ最適化 ===== */
.mypage-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 10px;
}

/* 💳 残高・メールカード */
.user-info-card {
  background: #000814;
  border: 2px solid #0dcaf0;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  text-align: center;
  box-shadow: 0 0 10px rgba(13, 202, 240, 0.5);
}

.user-info-card p {
  margin: 5px 0;
  font-size: 1rem;
}

/* パスワード変更フォーム */
.password-form {
  background: #0d1117;
  border: 1px solid #30363d;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 25px;
}

.password-form label {
  color: #c9d1d9;
  font-weight: 600;
}

.password-form input {
  width: 100%;
  margin-bottom: 10px;
  background: #000814;
  color: #0dcaf0;
  border: 1px solid #0dcaf0;
  border-radius: 5px;
  padding: 10px;
}

.password-form button {
  width: 100%;
  background: #0dcaf0;
  color: #000;
  border: none;
  font-weight: bold;
  padding: 10px;
  border-radius: 5px;
  transition: 0.3s;
}
.password-form button:hover {
  background: #00b5e0;
}

/* 注文履歴カード */
.order-card {
  background: #0d1117;
  border: 1px solid #0dcaf0;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  font-size: 0.9rem;
}

.order-card .text-info {
  color: #0dcaf0 !important;
}

.order-card .text-warning {
  color: #ffc107 !important;
}

@media (max-width: 768px) {
  h2 {
    font-size: 1.3rem;
    text-align: center;
  }
  .order-card {
    font-size: 0.85rem;
  }
}
</style>
