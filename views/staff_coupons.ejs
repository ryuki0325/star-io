<% title = 'ã‚¯ãƒ¼ãƒãƒ³ç®¡ç†' %>
<div class="container py-4 text-light">
  <h2>ğŸ ã‚¯ãƒ¼ãƒãƒ³ç®¡ç†</h2>

  <form method="POST" class="mb-4">
    <input type="text" name="code" placeholder="ã‚³ãƒ¼ãƒ‰" required>
    <input type="number" name="discount_value" placeholder="é‡‘é¡" required>
    <input type="date" name="valid_until" required>
    <input type="number" name="max_uses" placeholder="æœ€å¤§ä½¿ç”¨å›æ•°" value="1">
    <button type="submit" class="btn btn-success">ç™ºè¡Œ</button>
  </form>

  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th>ã‚³ãƒ¼ãƒ‰</th>
        <th>é‡‘é¡</th>
        <th>æœ‰åŠ¹æœŸé™ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰</th>
        <th>ä½¿ç”¨æ•°</th>
      </tr>
    </thead>
    <tbody>
      <% coupons.forEach(c => { 
           const expiryDate = new Date(c.valid_until);
           // UTC â†’ JST (+9æ™‚é–“)
           expiryDate.setHours(expiryDate.getHours() + 9);
           const expiryStr = expiryDate.toLocaleString('ja-JP', {
             year: 'numeric', month: '2-digit', day: '2-digit',
             hour: '2-digit', minute: '2-digit'
           });
      %>
        <tr>
          <td>
            <span class="code-text"><%= c.code %></span>
            <button type="button"
                    class="btn btn-sm btn-outline-info ms-2 copy-btn"
                    data-code="<%= c.code %>"
                    data-amount="<%= c.discount_value %>"
                    data-expiry="<%= expiryStr %>">
              ãƒ†ãƒ³ãƒ—ãƒ¬ã‚³ãƒ”ãƒ¼
            </button>
          </td>
          <td><%= c.discount_value %>å††</td>
          <td><%= expiryStr %></td>
          <td><%= c.used_count %>/<%= c.max_uses %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>
  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }
  }

  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const code = btn.dataset.code;
      const amount = btn.dataset.amount;
      const expiry = btn.dataset.expiry;

      const message =
        `ğŸ ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã§ã™ã€‚\n` +
        `ã‚µã‚¤ãƒˆå†…ã®è³¼å…¥ç”»é¢ã§å…¥åŠ›ã™ã‚‹ã¨ ${amount}å†† ã®å‰²å¼•ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚\n` +
        `ä½¿ç”¨æœŸé™ ${expiry} \n` +
        `ã”åˆ©ç”¨ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚`;

      const ok = await copyText(message);
      const old = btn.textContent;
      btn.textContent = ok ? 'âœ… ã‚³ãƒ”ãƒ¼æ¸ˆ' : 'âš ï¸ å¤±æ•—';
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = old;
        btn.disabled = false;
      }, 1200);
    });
  });
</script>
