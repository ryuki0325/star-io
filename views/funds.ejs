<% title = 'ğŸ’°æ®‹é«˜ãƒãƒ£ãƒ¼ã‚¸' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">ğŸ’° æ®‹é«˜ãƒãƒ£ãƒ¼ã‚¸</h2>

  <!-- ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º -->
  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <!-- æ®‹é«˜è¡¨ç¤º -->
  <div class="card bg-dark border-info p-3 mb-4 text-white">
    <p class="mb-0">ç¾åœ¨ã®æ®‹é«˜</p>
    <h4 class="fw-bold text-info mb-0"><%= Number(balance).toFixed(2) %> å††</h4>
  </div>

  <!-- Stripe ãƒãƒ£ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="chargeForm">
    <div class="mb-3">
      <label for="chargeAmount" class="form-label fw-bold">ãƒãƒ£ãƒ¼ã‚¸é‡‘é¡ï¼ˆ1000å††ä»¥ä¸Šï¼‰</label>
      <input type="number" id="chargeAmount" name="amount"
             class="form-control bg-dark text-light border-info"
             min="1000" step="100" required>
    </div>

    <!-- ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯é¸æŠ -->
    <div class="mb-3">
      <label class="form-label fw-bold">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
      <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-outline-info quick-btn" data-value="1000">1000å††</button>
        <button type="button" class="btn btn-outline-info quick-btn" data-value="2000">2000å††</button>
        <button type="button" class="btn btn-outline-info quick-btn" data-value="5000">5000å††</button>
        <button type="button" class="btn btn-outline-info quick-btn" data-value="10000">10000å††</button>
      </div>
    </div>

    <button type="submit" class="btn btn-info w-100 fw-bold">Stripeã§ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹</button>
  </form>
</div>

<!-- Stripe.js èª­ã¿è¾¼ã¿ -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("<%= process.env.STRIPE_PUBLISHABLE_KEY %>");

  // ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ
  document.querySelectorAll(".quick-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.getElementById("chargeAmount").value = btn.dataset.value;
    });
  });

  // Stripeã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
  document.getElementById("chargeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const amount = document.getElementById("chargeAmount").value;

    const res = await fetch("/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount })
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });
</script>

<!-- ã‚®ãƒ•ãƒˆã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="container py-4 text-light">
  <h3 class="mb-3">ğŸ ã‚®ãƒ•ãƒˆ / ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰</h3>
  <form action="/redeem" method="POST" class="bg-dark p-3 rounded border border-info">
    <div class="mb-3">
      <label for="code" class="form-label fw-bold">ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
      <input type="text" id="code" name="code" class="form-control bg-dark text-light border-info" required>
    </div>
    <button type="submit" class="btn btn-info w-100 fw-bold">é©ç”¨ã™ã‚‹</button>
  </form>
</div>
