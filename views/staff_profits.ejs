<% title = "åˆ©ç›Šä¸€è¦§" %>

<div class="container py-4 text-light">
  <h2 class="mb-4">ğŸ“Š åˆ©ç›Šä¸€è¦§</h2>

  <!-- âœ… æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
    <div>
      <label>é–‹å§‹æ—¥ï¼š</label>
      <input type="date" id="startDate" class="form-control d-inline-block w-auto">
    </div>
    <div>
      <label>çµ‚äº†æ—¥ï¼š</label>
      <input type="date" id="endDate" class="form-control d-inline-block w-auto">
    </div>
    <button id="filterButton" class="btn btn-info fw-bold">çµã‚Šè¾¼ã¿</button>
  </div>

  <!-- âœ… æœŸé–“ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ -->
  <div class="date-shortcuts d-flex flex-wrap gap-2 mb-4">
    <button class="btn btn-outline-info btn-sm" onclick="setDays(1)">éå»1æ—¥</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(7)">éå»1é€±é–“</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(10)">éå»10æ—¥</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(30)">éå»1ãƒ¶æœˆ</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(90)">éå»3ãƒ¶æœˆ</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(180)">éå»6ãƒ¶æœˆ</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(365)">éå»1å¹´</button>
  </div>

  <!-- âœ… æ¤œç´¢ãƒãƒ¼ -->
  <input 
    type="text" 
    id="searchInput" 
    class="form-control mb-3" 
    placeholder="ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¾ãŸã¯ ã‚µãƒ¼ãƒ“ã‚¹åã§æ¤œç´¢..."
  >

  <!-- âœ… åˆ©ç›Šãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div id="profitTableContainer" style="display:none;">
    <table class="table table-dark table-striped table-hover align-middle text-center">
      <thead class="table-info text-dark">
        <tr>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
          <th>ã‚µãƒ¼ãƒ“ã‚¹å</th>
          <th>æ•°é‡</th>
          <th>è²©å£²ä¾¡æ ¼(å††)</th>
          <th>ä»•å…¥ã‚Œä¾¡æ ¼(å††)</th>
          <th>åˆ©ç›Š(å††)</th>
          <th>æ—¥ä»˜</th>
        </tr>
      </thead>
      <tbody id="profitBody"></tbody>
    </table>
    <div id="totalProfit" class="text-end text-success fw-bold fs-5 mt-2"></div>
  </div>
</div>

<!-- âœ… JavaScript -->
<script>
  // ğŸ“† æœŸé–“ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¨­å®š
  function setDays(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);
    document.getElementById("startDate").value = start.toISOString().slice(0,10);
    document.getElementById("endDate").value = end.toISOString().slice(0,10);
  }

  // ğŸ§® ã€Œçµã‚Šè¾¼ã¿ã€ãƒœã‚¿ãƒ³ã§DBã‹ã‚‰åˆ©ç›Šãƒ‡ãƒ¼ã‚¿å–å¾—
  document.getElementById("filterButton").addEventListener("click", async () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!start || !end) {
      alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„");
      return;
    }

    const container = document.getElementById("profitTableContainer");
    container.style.display = "block";

    try {
      const res = await fetch(`/api/profit?start=${start}&end=${end}`);
      const data = await res.json();
      renderTable(data);
    } catch (err) {
      console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  });

  // ğŸ” æ¤œç´¢ãƒãƒ¼å…¥åŠ›æ™‚
  document.getElementById("searchInput").addEventListener("input", () => {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#profitBody tr");

    let visibleProfit = 0;
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      const visible = text.includes(keyword);
      row.style.display = visible ? "" : "none";
      if (visible) visibleProfit += parseFloat(row.dataset.profit);
    });

    document.getElementById("totalProfit").textContent = 
      `ğŸ’° åˆè¨ˆåˆ©ç›Š: ${visibleProfit.toFixed(2)} å††`;
  });

  // ğŸ’° ãƒ†ãƒ¼ãƒ–ãƒ«æç”»é–¢æ•°
  function renderTable(data) {
    const tbody = document.getElementById("profitBody");
    tbody.innerHTML = "";

    let total = 0;
    data.forEach(d => {
      const tr = document.createElement("tr");
      tr.dataset.profit = d.profit;
      tr.innerHTML = `
        <td>${d.user}</td>
        <td>${d.service}</td>
        <td>${Number(d.qty).toLocaleString()}</td>
        <td>${Number(d.price).toFixed(2)}</td>
        <td>${Number(d.cost).toFixed(2)}</td>
        <td class="text-success fw-bold">${Number(d.profit).toFixed(2)}</td>
        <td>${d.date}</td>
      `;
      tbody.appendChild(tr);
      total += parseFloat(d.profit);
    });

    document.getElementById("totalProfit").textContent =
      `ğŸ’° åˆè¨ˆåˆ©ç›Š: ${total.toFixed(2)} å††`;
  }
</script>

<!-- âœ… ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
  .table-dark th, .table-dark td {
    font-size: 0.95rem;
    vertical-align: middle;
  }
  .table-dark th {
    background: #0dcaf0 !important;
    color: #000 !important;
  }
  .table-dark tbody tr:hover {
    background-color: rgba(13,202,240,0.1);
  }
  .date-shortcuts button {
    border-width: 2px;
    transition: all 0.2s;
  }
  .date-shortcuts button:hover {
    background: #0dcaf0;
    color: #000;
    font-weight: bold;
  }
  #searchInput {
    border: 2px solid #0dcaf0;
    background: #000814;
    color: #0dcaf0;
    text-align: center;
    font-weight: bold;
  }
</style>
