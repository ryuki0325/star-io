<% title = "利益一覧" %>

<div class="container py-4 text-light">
  <h2 class="mb-4">📊 利益一覧</h2>

  <!-- ✅ 日付フィルター -->
  <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
    <div>
      <label>開始日：</label>
      <input type="date" id="startDate" class="form-control d-inline-block w-auto">
    </div>
    <div>
      <label>終了日：</label>
      <input type="date" id="endDate" class="form-control d-inline-block w-auto">
    </div>
    <button id="filterButton" class="btn btn-info fw-bold">絞り込み</button>
  </div>

  <!-- ✅ 期間ショートカット -->
  <div class="date-shortcuts d-flex flex-wrap gap-2 mb-4">
    <button class="btn btn-outline-info btn-sm" onclick="setDays(1)">過去1日</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(7)">過去1週間</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(10)">過去10日</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(30)">過去1ヶ月</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(90)">過去3ヶ月</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(180)">過去6ヶ月</button>
    <button class="btn btn-outline-info btn-sm" onclick="setDays(365)">過去1年</button>
  </div>

  <!-- ✅ 検索バー -->
  <input 
    type="text" 
    id="searchInput" 
    class="form-control mb-3" 
    placeholder="🔍 ユーザーID または サービス名で検索..."
  >

  <!-- ✅ 利益テーブル -->
  <div id="profitTableContainer" style="display:none;">
    <table class="table table-dark table-striped table-hover align-middle text-center">
      <thead class="table-info text-dark">
        <tr>
          <th>ユーザーID</th>
          <th>サービス名</th>
          <th>数量</th>
          <th>販売価格(円)</th>
          <th>仕入れ価格(円)</th>
          <th>利益(円)</th>
          <th>日付</th>
        </tr>
      </thead>
      <tbody id="profitBody"></tbody>
    </table>
    <div id="totalProfit" class="text-end text-success fw-bold fs-5 mt-2"></div>
  </div>
</div>

<!-- ✅ JavaScript -->
<script>
  // 📆 期間ショートカット設定
  function setDays(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);
    document.getElementById("startDate").value = start.toISOString().slice(0,10);
    document.getElementById("endDate").value = end.toISOString().slice(0,10);
  }

  // 🧮 「絞り込み」ボタンでDBから利益データ取得
  document.getElementById("filterButton").addEventListener("click", async () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!start || !end) {
      alert("日付を選択してください");
      return;
    }

    const container = document.getElementById("profitTableContainer");
    container.style.display = "block";

    try {
      const res = await fetch(`/api/profit?start=${start}&end=${end}`);
      const data = await res.json();
      renderTable(data);
    } catch (err) {
      console.error("データ取得エラー:", err);
      alert("サーバーからデータを取得できませんでした。");
    }
  });

  // 🔍 検索バー入力時
  document.getElementById("searchInput").addEventListener("input", () => {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#profitBody tr");

    let visibleProfit = 0;
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      const visible = text.includes(keyword);
      row.style.display = visible ? "" : "none";
      if (visible) visibleProfit += parseFloat(row.dataset.profit);
    });

    document.getElementById("totalProfit").textContent = 
      `💰 合計利益: ${visibleProfit.toFixed(2)} 円`;
  });

  // 💰 テーブル描画関数
  function renderTable(data) {
    const tbody = document.getElementById("profitBody");
    tbody.innerHTML = "";

    let total = 0;
    data.forEach(d => {
      const tr = document.createElement("tr");
      tr.dataset.profit = d.profit;
      tr.innerHTML = `
        <td>${d.user}</td>
        <td>${d.service}</td>
        <td>${Number(d.qty).toLocaleString()}</td>
        <td>${Number(d.price).toFixed(2)}</td>
        <td>${Number(d.cost).toFixed(2)}</td>
        <td class="text-success fw-bold">${Number(d.profit).toFixed(2)}</td>
        <td>${d.date}</td>
      `;
      tbody.appendChild(tr);
      total += parseFloat(d.profit);
    });

    document.getElementById("totalProfit").textContent =
      `💰 合計利益: ${total.toFixed(2)} 円`;
  }
</script>

<!-- ✅ スタイル -->
<style>
  .table-dark th, .table-dark td {
    font-size: 0.95rem;
    vertical-align: middle;
  }
  .table-dark th {
    background: #0dcaf0 !important;
    color: #000 !important;
  }
  .table-dark tbody tr:hover {
    background-color: rgba(13,202,240,0.1);
  }
  .date-shortcuts button {
    border-width: 2px;
    transition: all 0.2s;
  }
  .date-shortcuts button:hover {
    background: #0dcaf0;
    color: #000;
    font-weight: bold;
  }
  #searchInput {
    border: 2px solid #0dcaf0;
    background: #000814;
    color: #0dcaf0;
    text-align: center;
    font-weight: bold;
  }
</style>
