<% title = 'åˆ©ç›Šä¸€è¦§' %>

<div class="container py-4 text-light">

  <h2 class="mb-4">ğŸ“Š åˆ©ç›Šä¸€è¦§</h2>

  <!-- ==================== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI ==================== -->
  <div class="bg-dark p-4 rounded border border-info mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label>é–‹å§‹æ—¥</label>
        <input type="date" id="startDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label>çµ‚äº†æ—¥</label>
        <input type="date" id="endDate" class="form-control">
      </div>
      <div class="col-md-2">
        <button id="filterBtn" class="btn btn-info w-100 fw-bold">çµã‚Šè¾¼ã¿ ğŸ”</button>
      </div>
    </div>

    <!-- ğŸ“… ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
    <div class="mt-3 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-info btn-sm range-btn" data-days="1">éå»1æ—¥</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="7">éå»1é€±é–“</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="10">éå»10æ—¥</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="30">éå»1ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="90">éå»3ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="180">éå»6ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="365">éå»1å¹´</button>
    </div>

    <!-- ğŸ—“ï¸ å¹´ãƒ»æœˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="mt-4 row g-2 align-items-center">
      <div class="col-md-2">
        <label class="fw-bold">ğŸ“… å¹´åº¦é¸æŠ</label>
        <select id="yearSelect" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <label class="fw-bold">ğŸ—“ï¸ æœˆé¸æŠ</label>
        <select id="monthSelect" class="form-select">
          <option value="">-- æœˆã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="col-md-2">
        <button id="monthFilterBtn" class="btn btn-outline-info w-100">ã“ã®æœˆã®åˆ©ç›Šã‚’è¦‹ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ==================== ãƒ†ãƒ¼ãƒ–ãƒ« ==================== -->
  <div id="tableWrapper" class="d-none">
    <table class="table table-dark table-striped table-bordered text-center align-middle">
      <thead class="table-info text-dark">
        <tr>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
          <th>ã‚µãƒ¼ãƒ“ã‚¹å</th>
          <th>æ•°é‡</th>
          <th>è²©å£²ä¾¡æ ¼(å††)</th>
          <th>ä»•å…¥ã‚Œä¾¡æ ¼(å††)</th>
          <th>ä»•å…¥ã‚Œä¾¡æ ¼($)</th>
          <th>åˆ©ç›Š(å††)</th>
          <th>æ—¥ä»˜</th>
        </tr>
      </thead>
      <tbody id="profitTable"></tbody>
    </table>

    <h4 class="text-end mt-3">
      ğŸ’° åˆè¨ˆåˆ©ç›Šï¼š
      <span id="totalProfit" class="text-warning fw-bold">0 å††</span>
    </h4>
  </div>

  <div id="noDataMsg" class="alert alert-secondary text-center d-none">
    ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
  </div>
</div>

<!-- ==================== ã‚¹ã‚¿ã‚¤ãƒ« ==================== -->
<style>
  body {
    background: #000814;
  }
  .container {
    max-width: 1000px;
  }
  table {
    border-radius: 10px;
    overflow: hidden;
  }
  .table thead th {
    background-color: #0dcaf0 !important;
  }
  .range-btn:hover, #monthFilterBtn:hover {
    background-color: #0dcaf0 !important;
    color: #000 !important;
  }
</style>

<!-- ==================== ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ==================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startDate = document.getElementById("startDate");
  const endDate = document.getElementById("endDate");
  const filterBtn = document.getElementById("filterBtn");
  const tableWrapper = document.getElementById("tableWrapper");
  const profitTable = document.getElementById("profitTable");
  const totalProfitEl = document.getElementById("totalProfit");
  const noDataMsg = document.getElementById("noDataMsg");
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const monthFilterBtn = document.getElementById("monthFilterBtn");

  // ==================== å¹´ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”Ÿæˆ ====================
  const currentYear = new Date().getFullYear();
  for (let y = 2023; y <= currentYear + 1; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = `${y}å¹´`;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }

  // ==================== æœˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”Ÿæˆ ====================
  const monthNames = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
  monthNames.forEach((name, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = name;
    monthSelect.appendChild(opt);
  });

  // ==================== å¹´æœˆé¸æŠãƒœã‚¿ãƒ³ ====================
  monthFilterBtn.addEventListener("click", () => {
    const year = parseInt(yearSelect.value, 10);
    const month = parseInt(monthSelect.value, 10);
    if (!year || !month) {
      alert("å¹´ã¨æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    const start = new Date(year, month - 1, 1);
    const end = new Date(year, month, 0);
    startDate.value = start.toISOString().split("T")[0];
    endDate.value = end.toISOString().split("T")[0];
  });

  // ==================== éå»æ—¥ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ====================
  document.querySelectorAll(".range-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const days = parseInt(btn.dataset.days, 10);
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);
      startDate.value = start.toISOString().split("T")[0];
      endDate.value = end.toISOString().split("T")[0];
    });
  });

  // ==================== çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³ ====================
  filterBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    const start = startDate.value;
    const end = endDate.value;
    if (!start || !end) {
      alert("é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    await fetchProfitData(start, end);
  });

  // ==================== ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•° ====================
  async function fetchProfitData(start, end) {
    try {
      const res = await fetch(`/staff/api/profit?start=${start}&end=${end}`);
      if (!res.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
      const data = await res.json();

      if (!data || data.length === 0) {
        tableWrapper.classList.add("d-none");
        noDataMsg.classList.remove("d-none");
        return;
      }

      noDataMsg.classList.add("d-none");
      tableWrapper.classList.remove("d-none");

      const rate = 150; // 1ãƒ‰ãƒ«=150å††ã¨ã—ã¦è¨ˆç®—
      let totalProfit = 0;
      profitTable.innerHTML = data.map(row => {
        const profit = parseFloat(row.profit).toFixed(2);
        const costUSD = (parseFloat(row.cost) / rate).toFixed(3); // å††ã‹ã‚‰ãƒ‰ãƒ«æ›ç®—
        totalProfit += parseFloat(profit);
        return `
          <tr>
            <td>${row.user}</td>
            <td>${row.service}</td>
            <td>${row.qty}</td>
            <td>${row.price}</td>
            <td>${row.cost}</td>
            <td>${costUSD}$</td>
            <td class="fw-bold text-${profit >= 0 ? 'success' : 'danger'}">${profit}</td>
            <td>${row.date}</td>
          </tr>
        `;
      }).join("");

      totalProfitEl.textContent = `${totalProfit.toFixed(2)} å††`;

    } catch (err) {
      console.error("âŒ å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  }
});
</script>
