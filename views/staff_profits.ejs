<% title = 'åˆ©ç›Šä¸€è¦§' %>

<div class="container py-4 text-light">

  <h2 class="mb-4">ğŸ“Š åˆ©ç›Šä¸€è¦§</h2>

  <!-- ==================== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI ==================== -->
  <div class="bg-dark p-4 rounded border border-info mb-4">
    <div class="row g-3 align-items-end">

      <div class="col-md-2">
        <label>é–‹å§‹æ—¥</label>
        <input type="date" id="startDate" class="form-control">
      </div>

      <div class="col-md-2">
        <label>çµ‚äº†æ—¥</label>
        <input type="date" id="endDate" class="form-control">
      </div>

      <div class="col-md-2">
        <label>ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ</label>
        <select id="serviceFilter" class="form-select">
          <option value="all">å…¨ã¦</option>
          <option value="TikTok">TikTok</option>
          <option value="Instagram">Instagram</option>
          <option value="Twitter">X(Twitter)</option>
          <option value="YouTube">YouTube</option>
        </select>
      </div>

      <div class="col-md-2">
        <label>å¹´åº¦</label>
        <select id="yearSelect" class="form-select"></select>
      </div>

      <div class="col-md-2">
        <label>æœˆ</label>
        <select id="monthSelect" class="form-select">
          <option value="">-- æœˆã‚’é¸æŠ --</option>
        </select>
      </div>

      <div class="col-md-2">
        <button id="filterBtn" class="btn btn-info w-100 fw-bold">æ¤œç´¢ ğŸ”</button>
      </div>
    </div>

    <!-- ğŸ“… ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆå…ƒã®ä½ç½®ï¼‰ -->
    <div class="mt-3 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-info btn-sm range-btn" data-days="1">éå»1æ—¥</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="7">éå»1é€±é–“</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="10">éå»10æ—¥</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="30">éå»1ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="90">éå»3ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="180">éå»6ãƒ¶æœˆ</button>
      <button class="btn btn-outline-info btn-sm range-btn" data-days="365">éå»1å¹´</button>
    </div>
  </div>

  <!-- âœ… CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ã®ä¸‹ï¼‰ -->
  <div class="d-flex justify-content-end mb-3">
    <button id="csvBtn" class="btn btn-success fw-bold">
      ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <!-- ==================== ãƒ†ãƒ¼ãƒ–ãƒ« ==================== -->
  <div id="tableWrapper" class="d-none">
    <table class="table table-dark table-striped table-bordered text-center align-middle">
      <thead class="table-info text-dark">
        <tr>
          <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</th>
          <th>ã‚µãƒ¼ãƒ“ã‚¹å</th>
          <th>æ•°é‡</th>
          <th>è²©å£²ä¾¡æ ¼(å††)</th>
          <th>ä»•å…¥ã‚Œä¾¡æ ¼(å††)</th>
          <th>ä»•å…¥ã‚Œä¾¡æ ¼($)</th>
          <th>åˆ©ç›Š(å††)</th>
          <th>æ—¥ä»˜</th>
        </tr>
      </thead>
      <tbody id="profitTable"></tbody>
    </table>

    <h4 class="text-end mt-3">
      ğŸ’° åˆè¨ˆåˆ©ç›Šï¼š
      <span id="totalProfit" class="text-warning fw-bold">0 å††</span>
    </h4>
  </div>

  <div id="noDataMsg" class="alert alert-secondary text-center d-none">
    ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
  </div>
</div>

<!-- ==================== ã‚¹ã‚¿ã‚¤ãƒ« ==================== -->
<style>
  body {
    background: #000814;
  }
  .container {
    max-width: 1100px;
  }
  table {
    border-radius: 10px;
    overflow: hidden;
  }
  .table thead th {
    background-color: #0dcaf0 !important;
  }
  .range-btn:hover, #filterBtn:hover {
    background-color: #0dcaf0 !important;
    color: #000 !important;
  }
</style>

<!-- ==================== ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ==================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const startDate = document.getElementById("startDate");
  const endDate = document.getElementById("endDate");
  const filterBtn = document.getElementById("filterBtn");
  const tableWrapper = document.getElementById("tableWrapper");
  const profitTable = document.getElementById("profitTable");
  const totalProfitEl = document.getElementById("totalProfit");
  const noDataMsg = document.getElementById("noDataMsg");
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const serviceFilter = document.getElementById("serviceFilter");
  const csvBtn = document.getElementById("csvBtn");

  // âœ… CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
  csvBtn.addEventListener("click", () => {
    const start = startDate.value;
    const end = endDate.value;
    const service = serviceFilter.value;

    if (!start || !end) {
      alert("CSVã‚’å‡ºã™å‰ã«ã€é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
      return;
    }

    const params = new URLSearchParams({
      start,
      end,
      platform: service || "all"
    });

    window.location.href = `/staff/profits/csv?${params.toString()}`;
  });

  // å¹´ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
  const currentYear = new Date().getFullYear();
  for (let y = 2023; y <= currentYear + 1; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = `${y}å¹´`;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }

  // æœˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
  const monthNames = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
  monthNames.forEach((name, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = name;
    monthSelect.appendChild(opt);
  });

  // å¹´æœˆã‚’é¸ã‚“ã ã‚‰è‡ªå‹•ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åæ˜ 
  function updateCalendarFromYM() {
    const y = parseInt(yearSelect.value, 10);
    const m = parseInt(monthSelect.value, 10);
    if (!y || !m) return;
    const start = new Date(y, m - 1, 1);
    const end = new Date(y, m, 0);
    startDate.value = start.toISOString().split("T")[0];
    endDate.value = end.toISOString().split("T")[0];
  }
  yearSelect.addEventListener("change", updateCalendarFromYM);
  monthSelect.addEventListener("change", updateCalendarFromYM);

  // éå»æœŸé–“ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  document.querySelectorAll(".range-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const days = parseInt(btn.dataset.days, 10);
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);
      startDate.value = start.toISOString().split("T")[0];
      endDate.value = end.toISOString().split("T")[0];
    });
  });

  // æ¤œç´¢ãƒœã‚¿ãƒ³
  filterBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    const start = startDate.value;
    const end = endDate.value;
    const service = serviceFilter.value;
    if (!start || !end) {
      alert("é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    await fetchProfitData(start, end, service);
  });

  // ãƒ‡ãƒ¼ã‚¿å–å¾—
  async function fetchProfitData(start, end, service) {
    try {
      const res = await fetch(`/staff/api/profit?start=${start}&end=${end}`);
      if (!res.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
      const data = await res.json();

      // ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      const filtered = service === "all"
        ? data
        : data.filter(row => row.service.toLowerCase().includes(service.toLowerCase()));

      // ä¸Š5ä»¶ä»¥å¤–ã§ä»•å…¥ã‚Œä¾¡æ ¼0å††ã¯é™¤å¤–
      const cleaned = filtered.filter((row, index) =>
        index < 5 || parseFloat(row.cost) > 0
      );

      if (!cleaned.length) {
        tableWrapper.classList.add("d-none");
        noDataMsg.classList.remove("d-none");
        return;
      }

      noDataMsg.classList.add("d-none");
      tableWrapper.classList.remove("d-none");

      const rate = 150;
      let totalProfit = 0;
      profitTable.innerHTML = cleaned.map(row => {
        const profit = parseFloat(row.profit).toFixed(2);
        const costUSD = (parseFloat(row.cost) / rate).toFixed(3);
        totalProfit += parseFloat(profit);

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ™‚é–“è¾¼ã¿ï¼‰
        let dateStr = "N/A";
        try {
          const parsedDate = new Date(row.created_at.replace(" ", "T"));
          if (!isNaN(parsedDate)) {
            dateStr = parsedDate.toLocaleString("ja-JP", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
              hour12: false
            });
          }
        } catch (e) {
          console.warn("âš ï¸ æ—¥ä»˜å¤‰æ›ã‚¨ãƒ©ãƒ¼:", row.created_at);
        }
        return `
          <tr>
            <td>${row.user}</td>
            <td>[ID:${row.service_id || "-"}] ${row.service}</td>
            <td>${row.qty}</td>
            <td>${row.price}</td>
            <td>${row.cost}</td>
            <td>${costUSD}$</td>
            <td class="fw-bold text-${profit >= 0 ? 'success' : 'danger'}">${profit}</td>
            <td>${dateStr}</td>
          </tr>
        `;
      }).join("");

      totalProfitEl.textContent = `${totalProfit.toFixed(2)} å††`;

    } catch (err) {
      console.error("âŒ å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      alert("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  }
});
</script>
