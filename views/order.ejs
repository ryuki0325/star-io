<% title = 'æ–°è¦æ³¨æ–‡' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">æ–°è¦æ³¨æ–‡</h2>

  <!-- âœ… æ®‹é«˜ -->
  <p class="mb-4">æ®‹é«˜: <%= Number(balance || 0) %> å††</p>

  <form action="/order" method="POST" class="bg-dark p-4 rounded border border-info-subtle shadow">
    <!-- ==== ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ ==== -->
    <div class="mb-3">
      <label class="form-label mb-2">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</label>
      <div class="d-flex flex-wrap gap-2">
        <% const emojiMap = {
             TikTok:"ğŸµ", Instagram:"ğŸ“¸", YouTube:"â–¶ï¸", Twitter:"âœ–ï¸",
             Spotify:"ğŸ§", Telegram:"âœˆï¸", Twitch:"ğŸ®", Facebook:"ğŸ‘¥", Reddit:"ğŸ‘½"
           };
           const quickApps = ["TikTok","Instagram","YouTube","Twitter","Spotify","Telegram","Twitch","Facebook","Reddit"];
        %>
        <% quickApps.forEach(q => { if (grouped[q]) { %>
          <button type="button"
                  class="app-chip btn btn-outline-info"
                  data-app="<%= q %>">
            <span class="me-1"><%= emojiMap[q] || "ğŸ§©" %></span><%= q %>
          </button>
        <% } }) %>
      </div>
    </div>

    <!-- ==== ã‚¢ãƒ—ãƒªé¸æŠ ==== -->
    <div class="mb-3">
      <label for="appSelect" class="form-label">ã‚¢ãƒ—ãƒªã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="appSelect" onchange="updateTypes()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <% (appOrder || []).forEach(app => { %>
            <option value="<%= app %>" <%= selectedApp === app ? "selected" : "" %>>
              <%= (emojiMap[app] || "ğŸ§©") + " " + app %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>

    <!-- ==== ç¨®é¡é¸æŠ ==== -->
    <div class="mb-3">
      <label for="typeSelect" class="form-label">ç¨®é¡ã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="typeSelect" onchange="updateServices()">
          <option value="">å…ˆã«ã‚¢ãƒ—ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</option>
        </select>
      </div>
    </div>

    <!-- ==== ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ ==== -->
    <div class="mb-3">
      <label for="serviceSelect" class="form-label">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠï¼ˆå®‰ã„é †ï¼‰</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="serviceSelect" name="serviceId" onchange="updatePrice()">
          <option value="">å…ˆã«ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>
        </select>
      </div>
      <div class="form-text text-secondary mt-1">ã€Œå˜ä¾¡: xxå††/1000ã€ã¯1000å˜ä½ã‚ãŸã‚Šã®é‡‘é¡ã§ã™</div>
    </div>

    <!-- ==== ãƒªãƒ³ã‚¯ ==== -->
    <div class="mb-3">
      <label for="link" class="form-label">ãƒªãƒ³ã‚¯</label>
      <input type="text" class="form-control bg-dark text-light border border-2 border-info" id="link" name="link" required>
    </div>

    <!-- ==== æ•°é‡ ==== -->
    <div class="mb-3">
      <label for="quantity" class="form-label">æ•°é‡</label>
      <input type="number" class="form-control bg-dark text-light border border-2 border-info" id="quantity" name="quantity" min="1" required oninput="updatePrice()">
    </div>

    <!-- âœ… é‡‘é¡è¡¨ç¤º -->
    <div class="card bg-black border border-3 border-info p-3 mb-3">
      <p id="priceDisplay" class="text-info fs-5 mb-0">é‡‘é¡: 0 å††</p>
    </div>

    <button type="submit" class="btn btn-info w-100 fw-bold py-2">æ³¨æ–‡ã™ã‚‹</button>
  </form>
</div>

<style>
  .select-wrap { overflow: hidden; }
  .select-wrap:focus-within { box-shadow: 0 0 0.6rem rgba(13, 202, 240, 0.5); }
  .app-chip{
    border-width: 2px !important;
    border-radius: 999px;
    padding: .45rem .9rem;
    font-weight: 600;
    backdrop-filter: blur(2px);
  }
  .app-chip.active,
  .app-chip:hover{
    background:#0dcaf0;
    color:#000;
  }
</style>

<script>
  const grouped   = <%- JSON.stringify(grouped) %>;
  const selectedApp = "<%= selectedApp %>";

  const typeIcons = {
    "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼": "ğŸ‘¥",
    "ã„ã„ã­": "â¤ï¸",
    "å†ç”Ÿæ•°": "â–¶ï¸",
    "ã‚³ãƒ¡ãƒ³ãƒˆ": "ğŸ’¬",
    "ã‚·ã‚§ã‚¢": "ğŸ”—",
    "ãã®ä»–": "âœ¨"
  };

  // âœ… ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚¯ãƒªãƒƒã‚¯
  document.addEventListener("click", (e) => {
    const chip = e.target.closest(".app-chip");
    if (!chip) return;
    const app = chip.dataset.app;
    document.querySelectorAll(".app-chip").forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    document.getElementById("appSelect").value = app;
    updateTypes();
  });

  function updateTypes() {
    const app = document.getElementById("appSelect").value;
    const typeSelect = document.getElementById("typeSelect");
    typeSelect.innerHTML = '<option value="">ç¨®é¡ã‚’é¸æŠ</option>';

    if (grouped[app]) {
      Object.keys(grouped[app]).forEach(type => {
        const opt = document.createElement("option");
        opt.value = type;
        opt.textContent = typeIcons[type] ? `${typeIcons[type]} ${type}` : type;
        typeSelect.appendChild(opt);
      });
    }
    resetServiceSelect();
    updatePrice();
  }

  // âœ… ã‚µãƒ¼ãƒ“ã‚¹é¸æŠï¼ˆå®‰ã„é †ï¼‰
  function updateServices() {
    const app = document.getElementById("appSelect").value;
    const type = document.getElementById("typeSelect").value;
    const serviceSelect = document.getElementById("serviceSelect");
    resetServiceSelect();

    if (grouped[app] && grouped[app][type]) {
      // ğŸ”½ å˜ä¾¡ã§ã‚½ãƒ¼ãƒˆï¼ˆå®‰ã„é †ï¼‰
      const sortedServices = [...grouped[app][type]].sort((a, b) => parseFloat(a.rate) - parseFloat(b.rate));

      sortedServices.forEach(svc => {
        const rate = parseFloat(svc.rate || 0);
        const icon = typeIcons[type] || "";
        const displayRate = Number.isInteger(rate) ? rate : rate.toFixed(2);

        const opt = document.createElement("option");
        opt.value = svc.service;
        opt.textContent = `${svc.service} - ${svc.name} ï½œ å˜ä¾¡: ${displayRate}å††/1000${icon} ï¼ˆMin ${svc.min} - Max ${svc.max}ï¼‰`;
        opt.dataset.rate = rate;
        serviceSelect.appendChild(opt);
      });
    }
    updatePrice();
  }

  function resetServiceSelect() {
    document.getElementById("serviceSelect").innerHTML = '<option value="">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ</option>';
  }

  // âœ… é‡‘é¡è¨ˆç®—
  function updatePrice() {
    const serviceSelect = document.getElementById("serviceSelect");
    const quantityInput = document.getElementById("quantity");
    const display = document.getElementById("priceDisplay");
    const rate = parseFloat(serviceSelect.selectedOptions[0]?.dataset.rate || 0);
    const quantity = Number(quantityInput.value || 0);

    if (rate > 0 && quantity > 0) {
      const total = (rate / 1000 * quantity);
      const displayPrice = Number.isInteger(total) ? total : total.toFixed(2);
      display.textContent = `é‡‘é¡: ${displayPrice} å††`;
    } else {
      display.textContent = "é‡‘é¡: 0 å††";
    }
  }

  // âœ… ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
  window.addEventListener("load", () => {
    if (selectedApp) {
      document.getElementById("appSelect").value = selectedApp;
      document.querySelectorAll(".app-chip").forEach(c => {
        if (c.dataset.app === selectedApp) c.classList.add("active");
      });
    }
    updateTypes();
  });
</script>