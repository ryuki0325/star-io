<% title = 'æ–°è¦æ³¨æ–‡' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">ğŸš€ æ–°è¦æ³¨æ–‡</h2>

  <!-- ğŸ’³ æ®‹é«˜è¡¨ç¤º -->
  <div class="balance-display">
    <div class="balance-label">ğŸ’³ æ®‹é«˜</div>
    <div class="balance-amount"><%= balance.toFixed(2) %> å††</div>
  </div>

  <!-- âœ… æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form action="/order" method="POST" class="bg-dark p-4 rounded border border-info-subtle shadow">

    <!-- ğŸ’ ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚¨ãƒªã‚¢ -->
    <h5 class="text-info fw-bold mb-3">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</h5>
    <div class="quick-grid mb-4">
      <% const emojiMap = { TikTok:"ğŸµ", Instagram:"ğŸ“¸", YouTube:"â–¶ï¸", Twitter:"âœ–ï¸", Spotify:"ğŸ§", Telegram:"âœˆï¸", Twitch:"ğŸ®", Facebook:"ğŸ‘¥", Reddit:"ğŸ‘½" }; %>
      <% const quickApps = ["TikTok","Instagram","YouTube","Twitter","Spotify","Telegram","Twitch","Facebook","Reddit"]; %>
      <% quickApps.forEach(q => { if (grouped[q]) { %>
        <button type="button" class="btn btn-outline-info quick-btn" data-app="<%= q %>">
          <%= emojiMap[q] || "ğŸ§©" %> <%= q %>
        </button>
      <% } }) %>
    </div>

    <!-- ğŸ” æ¤œç´¢ï¼‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI -->
    <div class="filter-bar mb-4">
      <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ¤œç´¢">
      <select id="sortSelect" class="form-select">
        <option value="default">ãŠã™ã™ã‚é †</option>
        <option value="low">ğŸ’° å®‰ã„é †</option>
        <option value="high">ğŸ’¸ é«˜ã„é †</option>
      </select>
      <select id="filterSelect" class="form-select">
        <option value="none">å…¨ã¦è¡¨ç¤º</option>
        <option value="instant">âš¡ å³æ™‚é–‹å§‹</option>
        <option value="refill">ğŸ” Refillä¿è¨¼ä»˜ã</option>
        <option value="non-drop">ğŸ•Šï¸ Non Drop</option>
        <option value="popular">ğŸ’ äººæ°—ãƒ»Premium</option>
      </select>
      <button type="button" id="resetFilters" class="btn btn-outline-light">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ==== ã‚¢ãƒ—ãƒªé¸æŠ ==== -->
    <div class="mb-3">
      <label for="appSelect" class="form-label">ã‚¢ãƒ—ãƒªã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="appSelect" onchange="updateTypes()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <% (appOrder || []).forEach(app => { %>
            <option value="<%= app %>" <%= (selectedApp === app) ? "selected" : "" %>><%= (emojiMap[app] || "ğŸ§©") + " " + app %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <!-- ==== ç¨®é¡é¸æŠ ==== -->
    <div class="mb-3">
      <label for="typeSelect" class="form-label">ç¨®é¡ã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="typeSelect" onchange="updateServices()">
          <option value="">å…ˆã«ã‚¢ãƒ—ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</option>
        </select>
      </div>
    </div>

    <!-- ==== ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ ==== -->
    <div class="mb-3">
      <label for="serviceSelect" class="form-label">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠï¼ˆæœ€çµ‚ä¾¡æ ¼é †ï¼‰</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="serviceSelect" name="serviceId" onchange="updatePrice()">
          <option value="">å…ˆã«ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>
        </select>
      </div>
      <div class="form-text text-secondary mt-1">ã€Œå˜ä¾¡: xxå††/1000ã€ã¯æœ€çµ‚ä¾¡æ ¼ã§ã™</div>
    </div>

    <!-- ==== ãƒªãƒ³ã‚¯ ==== -->
    <div class="mb-3">
      <label for="link" class="form-label">ãƒªãƒ³ã‚¯</label>
      <input
        type="text"
        class="form-control bg-dark text-light border border-2 border-info"
        id="link"
        name="link"
        placeholder="ä¾‹ï¼šhttp://example.com"
        value="<%= typeof link !== 'undefined' ? link : '' %>"
        required>
    </div>

    <!-- ==== æ•°é‡ ==== -->
    <div class="mb-3">
      <label for="quantity" class="form-label">æ•°é‡</label>
      <input
        type="number"
        class="form-control bg-dark text-light border border-2 border-info"
        id="quantity"
        name="quantity"
        min="1"
        value="<%= typeof quantity !== 'undefined' ? quantity : '' %>"
        required
        oninput="updatePrice()">
    </div>

    <!-- ğŸ”´ ã‚¨ãƒ©ãƒ¼/ğŸŸ¢ æˆåŠŸï¼ˆâ€»é‡‘é¡ã®ç›´å‰ã«è¡¨ç¤ºï¼‰ -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger fw-bold py-2 mb-2" role="alert">âš ï¸ <%= error %></div>
    <% } %>
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success fw-bold py-2 mb-2" role="alert">âœ… <%= success %></div>
    <% } %>

    <!-- âœ… é‡‘é¡è¡¨ç¤º -->
    <div class="card bg-black border border-3 border-info p-3 mb-3">
      <p id="priceDisplay" class="text-info fs-5 mb-0">
        é‡‘é¡: <%= (typeof totalPrice !== 'undefined') ? totalPrice : 0 %> å††
      </p>
    </div>

    <button type="submit" class="btn btn-info w-100 fw-bold py-2" id="orderButton" onclick="disableButton(this)">
      æ³¨æ–‡ã™ã‚‹
    </button>

    <script>
      function disableButton(btn) {
        btn.disabled = true;
        btn.innerText = "æ³¨æ–‡ä¸­...";
        btn.form.submit();
      }
    </script>
  </form>
</div>

<!-- âœ… ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

  /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼ˆä¾‹æ–‡ï¼‰ã®è‰²ã‚’ç™½ã‚°ãƒ¬ãƒ¼ */
  #link::placeholder { color: #cccccc; opacity: 1; }

  /* ğŸ’³ æ®‹é«˜ãƒ‡ã‚¶ã‚¤ãƒ³ */
  .balance-display{font-family:'Orbitron',sans-serif;color:#00eaff;background:#000814;padding:15px;border:2px solid #0dcaf0;border-radius:10px;text-align:center;box-shadow:0 0 15px rgba(13,202,240,.6);animation:glow 1.5s infinite alternate;margin-bottom:20px;}
  .balance-label{font-size:1.2rem;font-weight:600;color:#00eaff;margin-bottom:5px;}
  .balance-amount{font-weight:bold;font-size:2rem;color:#39ff14;text-shadow:0 0 10px #39ff14,0 0 20px #39ff14;}
  @keyframes glow{from{box-shadow:0 0 10px rgba(13,202,240,.4);}to{box-shadow:0 0 25px rgba(13,202,240,.9);}}

  .select-wrap{overflow:hidden;}
  .select-wrap:focus-within{box-shadow:0 0 .6rem rgba(13,202,240,.5);}
  .quick-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
  .quick-btn{font-weight:bold;border-radius:10px;padding:12px 0;transition:.2s;}
  .quick-btn:hover{background:#0dcaf0;color:#000;}

  .filter-bar{display:flex;flex-direction:column;gap:10px;}
  .filter-bar select,.filter-bar input{border:2px solid #0dcaf0;background:#000;color:#0dcaf0;font-weight:500;}
  .filter-bar button{border:2px solid #0dcaf0;color:#0dcaf0;background:transparent;transition:.3s;}
  .filter-bar button:hover{background:#0dcaf0;color:#000;font-weight:bold;}
  @media(min-width:768px){.filter-bar{flex-direction:row;align-items:center}.quick-grid{grid-template-columns:repeat(4,1fr)}.filter-bar input{flex:1}.filter-bar select{width:180px}.filter-bar button{width:120px}}

  #searchInput{border:2px solid #0dcaf0!important;background:#000814!important;color:#0dcaf0!important;font-weight:bold;text-align:center;box-shadow:0 0 10px rgba(13,202,240,.3);transition:.3s;}
  #searchInput::placeholder{color:#0dcaf0b3;}
  #searchInput:focus{background:#001427!important;box-shadow:0 0 15px rgba(13,202,240,.6);outline:none;}
</style>

<!-- âœ… ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ -->
<script>
  const grouped = <%- JSON.stringify(grouped) %>;
  const recommended = <%- JSON.stringify(recommended) %>;
  const selectedApp = "<%= typeof selectedApp !== 'undefined' ? selectedApp : '' %>";
  const selectedType = "<%= typeof selectedType !== 'undefined' ? selectedType : '' %>";
  const selectedServiceId = "<%= typeof selectedServiceId !== 'undefined' ? selectedServiceId : '' %>";

  // ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".quick-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const app = btn.dataset.app;
        const appSelect = document.getElementById("appSelect");
        appSelect.value = app;
        appSelect.dispatchEvent(new Event("change"));
        document.querySelectorAll(".quick-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
  });

  // ç¨®é¡æ›´æ–°
  function updateTypes(){
    const app=document.getElementById("appSelect").value;
    const typeSelect=document.getElementById("typeSelect");
    typeSelect.innerHTML="<option value=''>ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>";
    if(!app||!grouped[app])return;
    const em={"å†ç”Ÿæ•°":"â–¶ï¸","ã„ã„ã­":"â¤ï¸","ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼":"ğŸ‘¥","ã‚³ãƒ¡ãƒ³ãƒˆ":"ğŸ’¬","ã‚·ã‚§ã‚¢":"ğŸ”„","ãã®ä»–":"âœ¨"};
    Object.keys(grouped[app]).forEach(t=>{
      const op=document.createElement("option");
      op.value=t; op.textContent=(em[t]||"ğŸ§©")+" "+t;
      typeSelect.appendChild(op);
    });
    // å¾©å…ƒ
    if(selectedType){ typeSelect.value = selectedType; }
    updateServices();
  }

  // ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°
  function updateServices(){
    const app=document.getElementById("appSelect").value;
    const type=document.getElementById("typeSelect").value;
    const serviceSelect=document.getElementById("serviceSelect");
    serviceSelect.innerHTML="<option value=''>ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</option>";
    if(!app||!type||!grouped[app][type])return;

    const rec=[] , normal=[];
    grouped[app][type].forEach(s=>{
      const isRec=recommended.includes(String(s.service));
      (isRec?rec:normal).push(s);
    });
    [...rec,...normal].forEach(s=>{
      const op=document.createElement("option");
      op.value=s.service;
      op.dataset.finalRate=s.finalRate;
      const prefix=recommended.includes(String(s.service))?"ğŸ‘‘ãŠã™ã™ã‚ ":"";
      op.textContent=`${prefix}[${s.service}] ${s.name} ï¼ˆæœ€çµ‚ä¾¡æ ¼: ${s.finalRate.toFixed(2)}å††/1000ï¼‰`;
      serviceSelect.appendChild(op);
    });

    applyFilters();

    // å¾©å…ƒ
    if(selectedServiceId){ serviceSelect.value = selectedServiceId; }
    updatePrice();
  }

  // é‡‘é¡è¡¨ç¤º
  function updatePrice(){
    const sel=document.getElementById("serviceSelect");
    const qty=parseInt(document.getElementById("quantity").value,10)||0;
    const disp=document.getElementById("priceDisplay");
    if(!sel.value){ disp.textContent="é‡‘é¡: 0 å††"; return; }
    const rate=parseFloat(sel.options[sel.selectedIndex].dataset.finalRate||0);
    const price=Math.round((rate/1000)*qty*100)/100;
    disp.textContent=`é‡‘é¡: ${price} å††`;
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const sortSelect=document.getElementById("sortSelect");
  const filterSelect=document.getElementById("filterSelect");
  const searchInput=document.getElementById("searchInput");
  const resetBtn=document.getElementById("resetFilters");
  function applyFilters(){
    const sel=document.getElementById("serviceSelect");
    const keyword=(searchInput?.value||"").toLowerCase();
    const sort=sortSelect?.value||"default";
    const filter=filterSelect?.value||"none";
    const original=Array.from(sel.querySelectorAll("option")).slice(1);
    let opts=[...original];

    if(keyword) opts=opts.filter(o=>o.text.toLowerCase().includes(keyword));
    const re={instant:/instant|fast|0-1/i,refill:/refill|guarantee/i,"non-drop":/non.?drop/i,popular:/exclusive|premium|best/i};
    if(filter!=="none"&&re[filter]) opts=opts.filter(o=>re[filter].test(o.text));
    if(sort==="low") opts.sort((a,b)=>parseFloat(a.dataset.finalRate)-parseFloat(b.dataset.finalRate));
    if(sort==="high") opts.sort((a,b)=>parseFloat(b.dataset.finalRate)-parseFloat(a.dataset.finalRate));

    const ph=sel.options[0].cloneNode(true);
    sel.innerHTML=""; sel.appendChild(ph); opts.forEach(o=>sel.appendChild(o));
  }
  [sortSelect,filterSelect,searchInput].forEach(el=>{ if(el) el.addEventListener("input",applyFilters); });
  if(resetBtn){ resetBtn.addEventListener("click",()=>{ sortSelect.value="default"; filterSelect.value="none"; searchInput.value=""; updateServices(); applyFilters(); document.getElementById("priceDisplay").textContent="é‡‘é¡: 0 å††"; }); }

  // åˆæœŸå¾©å…ƒ
  document.addEventListener("DOMContentLoaded",()=>{
    if(selectedApp){
      document.getElementById("appSelect").value = selectedApp;
      updateTypes();
    }
  });
</script>



    
