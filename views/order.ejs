<% title = 'æ–°è¦æ³¨æ–‡' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">ğŸš€ æ–°è¦æ³¨æ–‡</h2>

 <!-- ğŸ’³ æ®‹é«˜è¡¨ç¤ºéƒ¨åˆ† -->
<div class="balance-display">
  ğŸ’³ æ®‹é«˜: <span class="balance-amount"><%= balance.toFixed(2) %> å††</span>
</div>

<!-- âœ… æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  -->
<form action="/order" method="POST" class="bg-dark p-4 rounded border border-info-subtle shadow">
  
  <!-- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <% if (typeof error !== "undefined" && error) { %>
    <div style="color: red; font-weight: bold; margin-bottom: 15px;">
      <%= error %>
    </div>
  <% } %>

 <!-- ğŸ’ ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚¨ãƒªã‚¢ -->
<h5 class="text-info fw-bold mb-3">ã‚¯ã‚¤ãƒƒã‚¯é¸æŠ</h5>

<div class="quick-grid mb-4">
  <% const emojiMap = {
       TikTok:"ğŸµ", Instagram:"ğŸ“¸", YouTube:"â–¶ï¸", Twitter:"âœ–ï¸",
       Spotify:"ğŸ§", Telegram:"âœˆï¸", Twitch:"ğŸ®", Facebook:"ğŸ‘¥", Reddit:"ğŸ‘½"
     };
     const quickApps = ["TikTok","Instagram","YouTube","Twitter","Spotify","Telegram","Twitch","Facebook","Reddit"];
  %>
  <% quickApps.forEach(q => { if (grouped[q]) { %>
    <button type="button"
            class="btn btn-outline-info quick-btn"
            data-app="<%= q %>">
      <%= emojiMap[q] || "ğŸ§©" %> <%= q %>
    </button>
  <% } }) %>
</div>

<!-- ğŸ” æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="search-bar mb-4">
  <input type="text" class="form-control" id="searchInput" placeholder="ğŸ” ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ¤œç´¢">
  <select id="sortSelect" class="form-select">
    <option value="default">ãŠã™ã™ã‚é †</option>
    <option value="low">ğŸ’° å®‰ã„é †</option>
    <option value="high">ğŸ’¸ é«˜ã„é †</option>
  </select>
</div>

<!-- ================== çµã‚Šè¾¼ã¿UI ================== -->
<div class="filter-bar" style="margin-bottom: 10px;">
  <label>ğŸ” æ¤œç´¢:</label>
  <input type="text" id="searchInput" placeholder="ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ¤œç´¢" style="width: 180px; margin-right: 10px;">

  <label>ä¸¦ã³æ›¿ãˆ:</label>
  <select id="sortSelect" style="margin-right: 10px;">
    <option value="default">ãŠã™ã™ã‚é †</option>
    <option value="low">ğŸ’° å®‰ã„é †</option>
    <option value="high">ğŸ’¸ é«˜ã„é †</option>
  </select>

  <label>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
  <select id="filterSelect" style="margin-right: 10px;">
    <option value="none">å…¨ã¦è¡¨ç¤º</option>
    <option value="instant">âš¡ å³æ™‚é–‹å§‹</option>
    <option value="refill">ğŸ” Refillä¿è¨¼ä»˜ã</option>
    <option value="non-drop">ğŸ•Šï¸ Non Drop</option>
    <option value="popular">ğŸ’ äººæ°—ãƒ»Premium</option>
  </select>

  <button id="resetFilters" style="background:#333;color:#fff;border:none;padding:4px 8px;cursor:pointer;">
    ãƒªã‚»ãƒƒãƒˆ
  </button>
</div>

    <!-- ==== ã‚¢ãƒ—ãƒªé¸æŠ ==== -->
    <div class="mb-3">
      <label for="appSelect" class="form-label">ã‚¢ãƒ—ãƒªã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="appSelect" onchange="updateTypes()">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <% (appOrder || []).forEach(app => { %>
            <option value="<%= app %>" <%= selectedApp === app ? "selected" : "" %>>
              <%= (emojiMap[app] || "ğŸ§©") + " " + app %>
            </option>
          <% }) %>
        </select>
      </div>
    </div>

    <!-- ==== ç¨®é¡é¸æŠ ==== -->
    <div class="mb-3">
      <label for="typeSelect" class="form-label">ç¨®é¡ã‚’é¸æŠ</label>
      <div class="select-wrap border border-3 border-info rounded">
        <select class="form-select bg-dark text-light border-0" id="typeSelect" onchange="updateServices()">
          <option value="">å…ˆã«ã‚¢ãƒ—ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</option>
        </select>
      </div>
    </div>

    <!-- ==== ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ ==== -->
<div class="mb-3">
  <label for="serviceSelect" class="form-label">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠï¼ˆæœ€çµ‚ä¾¡æ ¼é †ï¼‰</label>
  <div class="select-wrap border border-3 border-info rounded">
    <select class="form-select bg-dark text-light border-0" id="serviceSelect" name="serviceId" onchange="updatePrice()">
      <option value="">å…ˆã«ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>
    </select>
  </div>
  <div class="form-text text-secondary mt-1">ã€Œå˜ä¾¡: xxå††/1000ã€ã¯æœ€çµ‚ä¾¡æ ¼ã§ã™</div>
</div>

    <!-- ==== ãƒªãƒ³ã‚¯ ==== -->
    <div class="mb-3">
      <label for="link" class="form-label">ãƒªãƒ³ã‚¯</label>
      <input type="text" class="form-control bg-dark text-light border border-2 border-info" id="link" name="link" required>
    </div>

    <!-- ==== æ•°é‡ ==== -->
    <div class="mb-3">
      <label for="quantity" class="form-label">æ•°é‡</label>
      <input type="number" class="form-control bg-dark text-light border border-2 border-info" id="quantity" name="quantity" min="1" required oninput="updatePrice()">
    </div>

    <!-- âœ… é‡‘é¡è¡¨ç¤º -->
    <div class="card bg-black border border-3 border-info p-3 mb-3">
      <p id="priceDisplay" class="text-info fs-5 mb-0">é‡‘é¡: 0 å††</p>
    </div>

    <button type="submit" class="btn btn-info w-100 fw-bold py-2">æ³¨æ–‡ã™ã‚‹</button>
  </form>
</div>

<!-- âœ… æ®‹é«˜ç”¨ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

 .balance-display {
  font-family: 'Orbitron', sans-serif;
  font-size: 1.4rem;
  text-align: center;
  color: #00eaff;
  background: #000814;  /* âœ… é»’ç³»ã§çµ±ä¸€ */
  padding: 15px;
  border: 2px solid #0dcaf0;
  border-radius: 10px;
  margin-bottom: 20px;
  width: 100%;          /* âœ… ãƒ•ã‚©ãƒ¼ãƒ ã‚„ã‚«ãƒ¼ãƒ‰ã¨åŒã˜å¹… */
  box-shadow: 0 0 10px rgba(13, 202, 240, 0.6);
  animation: glow 1.5s infinite alternate;
}

@keyframes glow {
  from { box-shadow: 0 0 10px rgba(13, 202, 240, 0.4); }
  to   { box-shadow: 0 0 20px rgba(13, 202, 240, 0.9); }
}

.balance-amount {
  font-weight: bold;
  font-size: 1.8rem;
  color: #39ff14;
  text-shadow: 0 0 8px #39ff14, 0 0 15px #39ff14;
}

  .select-wrap { overflow: hidden; }
  .select-wrap:focus-within { box-shadow: 0 0 0.6rem rgba(13, 202, 240, 0.5); }
  .app-chip{
    border-width: 2px !important;
    border-radius: 999px;
    padding: .45rem .9rem;
    font-weight: 600;
    backdrop-filter: blur(2px);
  }
  .app-chip.active,
  .app-chip:hover{
    background:#0dcaf0;
    color:#000;
  }

/* --- ã‚¯ã‚¤ãƒƒã‚¯é¸æŠã‚’ã‚°ãƒªãƒƒãƒ‰åŒ– --- */
.quick-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* ã‚¹ãƒãƒ›ã¯2åˆ— */
  gap: 10px;
}

/* SNSãƒœã‚¿ãƒ³ */
.quick-btn {
  font-weight: bold;
  border-radius: 10px;
  padding: 12px 0;
  transition: all 0.2s;
}
.quick-btn:hover {
  background: #0dcaf0;
  color: #000;
}

/* æ¤œç´¢ãƒãƒ¼ */
.search-bar {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* ğŸ’» PCç‰ˆã§ã¯4åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
@media (min-width: 768px) {
  .quick-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  .search-bar {
    flex-direction: row;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("âœ… order.js åˆæœŸåŒ–é–‹å§‹");

  const appSelect     = document.getElementById("appSelect");
  const typeSelect    = document.getElementById("typeSelect");
  const serviceSelect = document.getElementById("serviceSelect");
  const sortSelect    = document.getElementById("sortSelect");
  const filterSelect  = document.getElementById("filterSelect");
  const searchInput   = document.getElementById("searchInput");
  const resetBtn      = document.getElementById("resetFilters");
  const qtyInput      = document.getElementById("quantity");
  const priceDisplay  = document.getElementById("priceDisplay");

  // âœ… app-chipã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ãƒ—ãƒªåˆ‡æ›¿
  document.querySelectorAll(".app-chip").forEach(btn => {
    btn.addEventListener("click", () => {
      const app = btn.dataset.app;
      appSelect.value = app;
      appSelect.dispatchEvent(new Event("change"));

      document.querySelectorAll(".app-chip").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  // ===================== ç¨®é¡ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æ›´æ–° =====================
  window.updateTypes = function () {
    const app = appSelect.value;
    typeSelect.innerHTML = "<option value=''>ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>";

    if (!app || !grouped[app]) return;

    const emoji = { "å†ç”Ÿæ•°": "â–¶ï¸", "ã„ã„ã­": "â¤ï¸", "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼": "ğŸ‘¥", "ã‚³ãƒ¡ãƒ³ãƒˆ": "ğŸ’¬", "ã‚·ã‚§ã‚¢": "ğŸ”„", "ãã®ä»–": "âœ¨" };
    Object.keys(grouped[app]).forEach(type => {
      const op = document.createElement("option");
      op.value = type;
      op.textContent = (emoji[type] || "ğŸ§©") + " " + type;
      typeSelect.appendChild(op);
    });
  };

  window.updateServices = function () {
  const app = appSelect.value;
  const type = typeSelect.value;
  serviceSelect.innerHTML = "<option value=''>ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</option>";

  if (!app || !type || !grouped[app][type]) return;

  grouped[app][type].forEach(service => {
    const op = document.createElement("option");
    op.value = service.service;
    op.dataset.finalRate = service.finalRate;
    op.dataset.price = service.finalRate;

    const isRecommended = recommended.includes(String(service.service));
    const prefix = isRecommended ? "ğŸ‘‘ãŠã™ã™ã‚ " : "";

    op.textContent = `${prefix}[${service.service}] ${service.name} ï¼ˆæœ€çµ‚ä¾¡æ ¼: ${service.finalRate.toFixed(2)}å††/1000ï¼‰`;
    serviceSelect.appendChild(op);
  });

  applyFilters();
};

  window.updatePrice = function () {
    const op = serviceSelect.options[serviceSelect.selectedIndex];
    const qty = parseInt(qtyInput.value, 10) || 0;
    const rate = parseFloat(op?.dataset.finalRate || 0);
    const price = Math.round((rate / 1000) * qty * 100) / 100;
    priceDisplay.textContent = `é‡‘é¡: ${price} å††`;
  };

  // ===================== ä¸¦ã³æ›¿ãˆ & çµã‚Šè¾¼ã¿ =====================
  function applyFilters() {
    const keyword = searchInput?.value?.toLowerCase() || "";
    const sort = sortSelect?.value || "default";
    const filter = filterSelect?.value || "none";

    const original = Array.from(serviceSelect.querySelectorAll("option")).slice(1);
    let options = [...original];

    if (keyword) options = options.filter(o => o.text.toLowerCase().includes(keyword));

    const regex = {
      instant: /instant|fast|0-1/i,
      refill: /refill|guarantee/i,
      "non-drop": /non.?drop/i,
      popular: /exclusive|premium|best/i
    };
    if (filter !== "none" && regex[filter]) {
      options = options.filter(o => regex[filter].test(o.text));
    }

    if (sort === "low") options.sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
    if (sort === "high") options.sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));

    const ph = serviceSelect.options[0].cloneNode(true);
    serviceSelect.innerHTML = "";
    serviceSelect.appendChild(ph);
    options.forEach(o => serviceSelect.appendChild(o));
  }

  [sortSelect, filterSelect, searchInput].forEach(el => {
    if (el) el.addEventListener("input", applyFilters);
  });

  if (resetBtn) {
  resetBtn.addEventListener("click", () => {
    console.log("ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ãƒªã‚»ãƒƒãƒˆ");

    // ====== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢é€£ã‚’åˆæœŸåŒ– ======
    sortSelect.value = "default";
    filterSelect.value = "none";
    searchInput.value = "";

    // ====== ç¾åœ¨é¸æŠä¸­ã®ã‚¢ãƒ—ãƒªãƒ»ç¨®é¡ã‚’ç¶­æŒã—ãŸã¾ã¾ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆã‚’å†æç”» ======
    if (typeof updateServices === "function") {
      updateServices(); // â† ç¨®é¡ãƒ»ã‚¢ãƒ—ãƒªã‚’å†èª­ã¿è¾¼ã¿
    }

    // ====== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å†é©ç”¨ï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰ ======
    applyFilters();

    // ====== é‡‘é¡è¡¨ç¤ºã¯ãƒªã‚»ãƒƒãƒˆ ======
    priceDisplay.textContent = "é‡‘é¡: 0 å††";

    console.log("âœ… æ¤œç´¢ãƒ»çµã‚Šè¾¼ã¿ãƒ»ä¸¦ã³æ›¿ãˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆã‚¢ãƒ—ãƒªãƒ»ç¨®é¡ã¯ä¿æŒï¼‰");
  });
}

  // ===================== åˆæœŸåŒ– =====================
  if (appSelect.value) updateTypes();

  console.log("âœ… order.js åˆæœŸåŒ–å®Œäº†");
});
</script>


<!-- âœ… ç¨®é¡ãƒ»ã‚µãƒ¼ãƒ“ã‚¹é¸æŠã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
  // grouped ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿
  const grouped = <%- JSON.stringify(grouped) %>;
  const recommended = <%- JSON.stringify(recommended) %>; // ğŸ‘‘è¿½åŠ ï¼

  // ==== ã‚¢ãƒ—ãƒªã‚’é¸ã‚“ã ã‚‰ç¨®é¡ã‚’æ›´æ–° ====
function updateTypes() {
  const app = document.getElementById("appSelect").value;
  const typeSelect = document.getElementById("typeSelect");
  typeSelect.innerHTML = "<option value=''>ç¨®é¡ã‚’é¸ã‚“ã§ãã ã•ã„</option>";

  if (!app || !grouped[app]) return;

  // ç¨®é¡ã”ã¨ã®çµµæ–‡å­—ãƒãƒƒãƒ—
  const typeEmojiMap = {
    "å†ç”Ÿæ•°": "â–¶ï¸",
    "ã„ã„ã­": "â¤ï¸",
    "ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼": "ğŸ‘¥",
    "ã‚³ãƒ¡ãƒ³ãƒˆ": "ğŸ’¬",
    "ã‚·ã‚§ã‚¢": "ğŸ”„",
    "ãã®ä»–": "âœ¨"
  };

  Object.keys(grouped[app]).forEach(type => {
    const option = document.createElement("option");
    option.value = type;
    option.textContent = (typeEmojiMap[type] || "ğŸ§©") + " " + type;
    typeSelect.appendChild(option);
  });
}

// ==== ç¨®é¡ã‚’é¸ã‚“ã ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ›´æ–° ====
function updateServices() {
  const app = document.getElementById("appSelect").value;
  const type = document.getElementById("typeSelect").value;
  const serviceSelect = document.getElementById("serviceSelect");
  serviceSelect.innerHTML = "<option value=''>ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</option>";

  // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã¯çµ‚äº†
  if (!app || !type || !grouped[app][type]) return;

  grouped[app][type].forEach(service => {
    const option = document.createElement("option");

    // âœ… IDã‚’ value ã«å…¥ã‚Œã‚‹
    option.value = service.service;

    // âœ… dataset ã« finalRate ã‚’ã‚»ãƒƒãƒˆï¼ˆupdatePrice ã§ä½¿ã†ï¼‰
    option.dataset.finalRate = service.finalRate;

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ recommended é…åˆ—ã‚’ä½¿ã£ã¦åˆ¤å®š
    const isRecommended = recommended.includes(String(service.service));

    // ğŸ‘‘ãŠã™ã™ã‚ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
const prefix = isRecommended ? "ğŸ‘‘ãŠã™ã™ã‚ " : "";

// âœ… è¡¨ç¤ºã¯ã€ŒãŠã™ã™ã‚ + ID + åå‰ + æœ€çµ‚ä¾¡æ ¼ã€
option.textContent = `${prefix}[${service.service}] ${service.name} ï¼ˆæœ€çµ‚ä¾¡æ ¼: ${service.finalRate.toFixed(2)}å††/1000ï¼‰`;

    serviceSelect.appendChild(option);
  });
}


// ==== ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸ã‚“ã ã‚‰é‡‘é¡ã‚’æ›´æ–° ====
function updatePrice() {
  const serviceSelect = document.getElementById("serviceSelect");
  const qty = parseInt(document.getElementById("quantity").value, 10) || 0;
  const priceDisplay = document.getElementById("priceDisplay");

  if (!serviceSelect.value) {
    priceDisplay.textContent = "é‡‘é¡: 0 å††";
    return;
  }

  // âœ… é¸æŠä¸­ã® option ã‹ã‚‰ data-final-rate ã‚’å–å¾—
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
  const finalRate = parseFloat(selectedOption.dataset.finalRate || "0");

  // âœ… é‡‘é¡è¨ˆç®—
  const price = Math.round((finalRate / 1000) * qty * 100) / 100;

  // âœ… è¡¨ç¤ºæ›´æ–°
  priceDisplay.textContent = `é‡‘é¡: ${price} å††`;
}
</script>



    
