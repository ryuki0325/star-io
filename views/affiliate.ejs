<% title = 'アフィリエイト紹介' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">🤝 アフィリエイト紹介プログラム</h2>

  <div class="alert alert-info">
    この紹介リンクから新規登録し、ギフトコードなどで入金した場合、
    <strong>入金額の5%</strong> があなたの残高として自動付与されます。
  </div>

  <!-- 紹介リンク -->
  <div class="card bg-dark border border-info mb-4 p-3">
    <h5 class="text-white">あなたの紹介リンク</h5>
    <div class="input-group">
      <input
        type="text"
        class="form-control bg-dark text-light"
        value="<%= inviteLink %>"
        readonly
        id="inviteLinkInput"
      >
      <button class="btn btn-info" type="button" onclick="copyInviteLink()">コピー</button>
    </div>
    <small class="text-white">SNS・友達・ブログなどで自由にシェアしてください。</small>
  </div>

  <!-- 集計カード -->
  <div class="row g-3 mb-4">

    <!-- 招待したユーザー数 -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-white">招待したユーザー数</div>
        <div class="fs-3 fw-bold text-white"><%= invitedCount %> 人</div>
      </div>
    </div>

    <!-- 紹介報酬 -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-muted">あなたが獲得した紹介報酬</div>
        <div class="fs-3 fw-bold text-info"><%= affiliateEarnings %> 円</div>
      </div>
    </div>

    <!-- ステータス -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-white">ステータス</div>
        <div class="fs-5 fw-bold text-white">
          <% if (invitedCount > 0) { %>
            👍 紹介が発生しています！
          <% } else { %>
            まだ紹介はありません。まずはリンクをシェアしてみましょう。
          <% } %>
        </div>
      </div>
    </div>

  </div>

  <!-- 招待ユーザー一覧 -->
<div class="card bg-dark border border-info p-3 mb-4">
  <h5 class="mb-3 text-white">👥 招待したユーザー一覧</h5>

  <% if (invitedUsers && invitedUsers.length > 0) { %>
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th>ユーザーID</th>
            <th>登録日時</th>
            <th>あなたの報酬</th> <!-- 追加 -->
          </tr>
        </thead>
        <tbody>
          <% invitedUsers.forEach(u => { %>
            <tr>
              <td><%= u.id %></td>
              <td>
                <% if (u.created_at) { %>
                  <%= new Date(u.created_at).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) %>
                <% } else { %>
                  -
                <% } %>
              </td>
              <td class="text-info fw-bold">
                <%= u.reward %> 円 <!-- ← 追加表示 -->
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <p class="text-muted mb-0">
      まだ招待されたユーザーはいません。紹介リンクをシェアしてみましょう。
    </p>
  <% } %>
</div>

  <!-- 受け取った紹介報酬一覧 -->
  <div class="card bg-dark border border-info p-3 mb-4">
    <h5 class="mb-3 text-white">💰 受け取った紹介報酬一覧</h5>

    <% if (rewardLogs && rewardLogs.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>ユーザーID</th>
              <th>元の入金額</th>
              <th>あなたの報酬</th>
              <th>日時</th>
            </tr>
          </thead>
          <tbody>
            <% rewardLogs.forEach(log => { %>
              <tr>
                <td><%= log.user_id %></td>
                <td><%= log.amount %> 円</td>
                <td class="text-info fw-bold"><%= log.reward %> 円</td>
                <td>
                  <%= new Date(log.created_at).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-muted mb-0">
        まだ紹介報酬はありません。
      </p>
    <% } %>
  </div>

  <p class="text-white">
    ※ 不正な自己紹介・複数アカウント作成・スパム行為が確認された場合は、
    紹介報酬の取消やアカウント停止となる場合があります。
  </p>
</div>

<script>
  function copyInviteLink() {
    const input = document.getElementById('inviteLinkInput');
    input.select();
    document.execCommand('copy');
    alert('紹介リンクをコピーしました！');
  }
</script>
