<% title = 'アフィリエイト紹介' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">🤝 アフィリエイト紹介プログラム</h2>

  <% if (success) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>
  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <div class="alert alert-info">
    あなたの紹介リンクから登録し、ギフトコードなどで入金すると、
    <strong>入金額の5%</strong> があなたに報酬として付与されます。
  </div>

  <!-- ==============================
       紹介リンク
  =============================== -->
  <div class="card bg-dark border border-info mb-4 p-3">
    <h5 class="text-white">あなたの紹介リンク</h5>
    <div class="input-group">
      <input
        type="text"
        class="form-control bg-dark text-light"
        value="<%= inviteLink %>"
        readonly
        id="inviteLinkInput"
      >
      <button class="btn btn-info" onclick="copyInviteLink()">コピー</button>
    </div>
    <small class="text-white">SNS・友達・ブログに自由に貼り付けてOKです。</small>
  </div>

  <!-- ==============================
       集計カード（あなたの数字）
  =============================== -->
  <div class="row g-3 mb-4">

    <!-- 招待人数 -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-white">招待したユーザー数</div>
        <div class="fs-3 fw-bold text-white"><%= invitedCount %> 人</div>
      </div>
    </div>

    <!-- 累計紹介報酬 -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-muted">累計紹介報酬</div>
        <div class="fs-3 fw-bold text-info"><%= affiliateEarnings %> 円</div>
      </div>
    </div>

    <!-- ステータス -->
    <div class="col-md-4">
      <div class="card bg-dark border border-info p-3 h-100">
        <div class="text-white">ステータス</div>
        <div class="fs-5 fw-bold text-white">
          <% if (invitedCount > 0) { %>
            👍 紹介が発生しています！
          <% } else { %>
            まだ紹介ユーザーがいません。
          <% } %>
        </div>
      </div>
    </div>

  </div>

    <!-- ==============================
       出金パネル（3種類）
  =============================== -->
  <div class="card bg-dark border border-info p-3 mb-4">
    <h5 class="text-white mb-3">💴 アフィリエイト出金</h5>

    <div class="mb-2">
      <span class="text-white-50">現在の出金可能残高：</span>
      <span class="fs-3 fw-bold text-warning"><%= withdrawableAmount %> 円</span>
    </div>
    <small class="text-white-50 d-block mb-3">
      ※ 累計紹介報酬 − これまでの申請額 = 出金可能残高
    </small>

    <div class="row g-3">

      <!-- 残高換金（即時反映） -->
      <div class="col-md-4">
        <div class="rounded p-3 h-100 border border-info"
             style="background-color:#0b1926;">
          <h6 class="mb-2" style="color:#ffd966;">💰 残高に換金</h6>
          <form action="/affiliate/withdraw/balance" method="POST">
            <input
              type="number"
              name="amount"
              class="form-control bg-dark text-light mb-2"
              min="1"
              max="<%= withdrawableAmount %>"
              placeholder="金額を入力"
              required
            >
            <button class="btn btn-info w-100" type="submit">残高に追加</button>
            <small class="text-white-50 d-block mt-2">※ 即時反映されます。</small>
          </form>
        </div>
      </div>

      <!-- PayPay換金（申請のみ） -->
      <div class="col-md-4">
        <div class="rounded p-3 h-100 border border-info"
             style="background-color:#0b1926;">
          <h6 class="mb-2" style="color:#9ad8ff;">📱 PayPay換金（1000円〜）</h6>
          <form action="/affiliate/withdraw/paypay" method="POST">
            <input
              type="number"
              name="amount"
              class="form-control bg-dark text-light mb-2"
              min="1000"
              max="<%= withdrawableAmount %>"
              placeholder="金額（1000円〜）"
              required
            >
            <input
              type="text"
              name="paypay_id"
              class="form-control bg-dark text-light mb-2"
              placeholder="PayPay ID"
              value="<%= paypayId %>"
              required
            >
            <button class="btn btn-outline-info w-100" type="submit">PayPay申請</button>
            <small class="text-white-50 d-block mt-2">
              ※ スタッフが承認後に送金されます。
            </small>
          </form>
        </div>
      </div>

      <!-- 銀行振込換金（申請のみ） -->
      <div class="col-md-4">
        <div class="rounded p-3 h-100 border border-info"
             style="background-color:#0b1926;">
          <h6 class="mb-2" style="color:#b3ffb3;">🏦 銀行振込（1000円〜）</h6>
          <form action="/affiliate/withdraw/bank" method="POST">
            <input
              type="number"
              name="amount"
              class="form-control bg-dark text-light mb-2"
              min="1000"
              max="<%= withdrawableAmount %>"
              placeholder="金額（1000円〜）"
              required
            >
            <input
              type="text"
              name="bank_name"
              class="form-control bg-dark text-light mb-2"
              placeholder="銀行名"
              value="<%= bankName %>"
              required
            >
            <input
              type="text"
              name="bank_branch"
              class="form-control bg-dark text-light mb-2"
              placeholder="支店名"
              value="<%= bankBranch %>"
              required
            >
            <input
              type="text"
              name="bank_account"
              class="form-control bg-dark text-light mb-2"
              placeholder="口座番号"
              value="<%= bankAccount %>"
              required
            >
            <button class="btn btn-outline-info w-100" type="submit">銀行振込申請</button>
            <small class="text-white-50 d-block mt-2">
              ※ スタッフ確認後に振込します。手数料はお客様負担です。
            </small>
          </form>
        </div>
      </div>

    </div>
  </div>

  <!-- ==============================
       招待ユーザー一覧
  =============================== -->
  <div class="card bg-dark border border-info p-3 mb-4">
    <h5 class="text-white mb-3">👥 招待したユーザー一覧</h5>

    <% if (invitedUsers.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-dark table-striped align-middle mb-0">
          <thead>
            <tr>
              <th>ユーザーID</th>
              <th>登録日時</th>
              <th>あなたの報酬</th>
            </tr>
          </thead>
          <tbody>
            <% invitedUsers.forEach(u => { %>
              <tr>
                <td><%= u.id %></td>
                <td><%= new Date(u.created_at).toLocaleString("ja-JP") %></td>
                <td class="text-info fw-bold"><%= u.reward %> 円</td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="text-muted">まだ招待ユーザーはいません。</p>
    <% } %>
  </div>

  <p class="text-muted">
    ※ 不正行為（自己紹介・複数アカ作成）が発覚した場合、報酬取消になる可能性があります。
  </p>
</div>

<script>
  function copyInviteLink() {
    const input = document.getElementById("inviteLinkInput");
    input.select();
    document.execCommand("copy");
    alert("紹介リンクをコピーしました！");
  }
</script>
