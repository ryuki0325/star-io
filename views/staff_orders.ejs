<% title = "å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è³¼å…¥å±¥æ­´" %>

<div class="container py-4 text-light">
  <h2 class="mb-4">ğŸ§¾ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è³¼å…¥å±¥æ­´</h2>

  <!-- ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-bar mb-4 d-flex flex-wrap gap-2 align-items-center">
    <input type="text" id="searchInput" class="form-control bg-dark text-light border-info" placeholder="ğŸ” ãƒ¡ãƒ¼ãƒ«ãƒ»IDãƒ»ãƒªãƒ³ã‚¯ã‚’æ¤œç´¢" style="max-width: 250px;">

    <select id="statusFilter" class="form-select bg-dark text-light border-info" style="max-width: 160px;">
      <option value="">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
      <option value="completed">å®Œäº†</option>
      <option value="inprogress">é€²è¡Œä¸­</option>
      <option value="pending">ä¿ç•™ä¸­</option>
      <option value="processing">å‡¦ç†ä¸­</option>
    </select>

    <select id="sortSelect" class="form-select bg-dark text-light border-info" style="max-width: 150px;">
      <option value="desc">ğŸ“… æ–°ã—ã„é †</option>
      <option value="asc">ğŸ“… å¤ã„é †</option>
    </select>

    <!-- ğŸ“… æ—¥ä»˜ç¯„å›² -->
    <input type="date" id="startDate" class="form-control bg-dark text-light border-info" style="max-width: 180px;">
    <input type="date" id="endDate" class="form-control bg-dark text-light border-info" style="max-width: 180px;">

    <button id="exportCSV" class="btn btn-outline-success">ğŸ“¤ CSVå‡ºåŠ›</button>
    <button id="resetFilters" class="btn btn-outline-info">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <% if (orders.length === 0) { %>
  <div class="alert alert-secondary">æ³¨æ–‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
<% } else { %>
  <div id="orderList">
    <% orders.forEach(order => { %>
      <div class="order-card card bg-dark border border-info mb-3 p-3">
        <p class="mb-1">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span class="user-email"><%= order.user_email %></span></p>
        <p class="mb-1">ğŸ’ ã‚µãƒ¼ãƒ“ã‚¹å: <span class="service-name"><%= order.service_name || "ä¸æ˜" %></span></p>
        <p class="mb-1 link-url">ğŸ”— ãƒªãƒ³ã‚¯: 
          <a href="<%= order.link %>" target="_blank"><%= order.link %></a>
        </p>
        <p class="mb-1 quantity">ğŸ“¦ æ•°é‡: <%= order.quantity %></p>
        <p class="mb-1 price">ğŸ’° é‡‘é¡: <%= order.price %> å††</p>
        <p class="mb-1 date">ğŸ“… æ—¥æ™‚: 
          <%= new Date(order.created_at).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" }) %>
        </p>
        <p class="mb-0 status">
          ğŸ“Œ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 
          <% 
            let jpStatus = "ä¸æ˜";
            if (order.status === "completed") jpStatus = "å®Œäº†";
            else if (order.status === "pending") jpStatus = "ä¿ç•™ä¸­";
            else if (order.status === "inprogress") jpStatus = "é€²è¡Œä¸­";
            else if (order.status === "processing") jpStatus = "å‡¦ç†ä¸­";
          %>
          <span class="badge 
            <%= order.status === 'completed' 
                ? 'bg-success' 
                : order.status === 'pending' 
                  ? 'bg-warning text-dark' 
                  : order.status === 'inprogress' 
                    ? 'bg-info text-dark' 
                    : 'bg-secondary' %>">
            <%= jpStatus %>
          </span>
        </p>
      </div>
    <% }) %>
  </div>
<% } %>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const sortSelect = document.getElementById("sortSelect");
  const resetBtn = document.getElementById("resetFilters");
  const orderList = document.getElementById("orderList");
  const startDate = document.getElementById("startDate");
  const endDate = document.getElementById("endDate");
  const exportCSV = document.getElementById("exportCSV");

  function filterOrders() {
    const keyword = searchInput.value.toLowerCase();
    const status = statusFilter.value;
    const sort = sortSelect.value;
    const start = startDate.value ? new Date(startDate.value) : null;
    const end = endDate.value ? new Date(endDate.value) : null;

    const cards = Array.from(orderList.getElementsByClassName("order-card"));
    let visibleCards = [];

    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      const dateText = card.querySelector("p:nth-child(6)").textContent.replace("ğŸ“… æ—¥æ™‚: ", "");
      const orderDate = new Date(dateText);

      const matchKeyword = keyword === "" || text.includes(keyword);
      const matchStatus = status === "" || text.includes(status);
      const matchStart = !start || orderDate >= start;
      const matchEnd = !end || orderDate <= end;

      if (matchKeyword && matchStatus && matchStart && matchEnd) {
        visibleCards.push(card);
      }
    });

    visibleCards.sort((a, b) => {
      const dateA = new Date(a.querySelector("p:nth-child(6)").textContent.replace("ğŸ“… æ—¥æ™‚: ", ""));
      const dateB = new Date(b.querySelector("p:nth-child(6)").textContent.replace("ğŸ“… æ—¥æ™‚: ", ""));
      return sort === "desc" ? dateB - dateA : dateA - dateB;
    });

    orderList.innerHTML = "";
    visibleCards.forEach(c => orderList.appendChild(c));
  }

  [searchInput, statusFilter, sortSelect, startDate, endDate].forEach(el => {
    el.addEventListener("input", filterOrders);
  });

  resetBtn.addEventListener("click", () => {
    searchInput.value = "";
    statusFilter.value = "";
    sortSelect.value = "desc";
    startDate.value = "";
    endDate.value = "";
    filterOrders();
  });

  // ğŸ“¤ CSVå‡ºåŠ›æ©Ÿèƒ½
  exportCSV.addEventListener("click", () => {
    const rows = [["ãƒ¦ãƒ¼ã‚¶ãƒ¼", "ã‚µãƒ¼ãƒ“ã‚¹ID", "ãƒªãƒ³ã‚¯", "æ•°é‡", "é‡‘é¡(å††)", "æ—¥æ™‚", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"]];
    const cards = Array.from(orderList.getElementsByClassName("order-card"));
    cards.forEach(card => {
      const cells = Array.from(card.querySelectorAll("p")).map(p => p.textContent.replace(/^[ğŸ“…ğŸ“ŒğŸ‘¤ğŸ†”ğŸ”—ğŸ“¦ğŸ’° ]+/g, "").trim());
      rows.push(cells);
    });

    let csvContent = rows.map(e => e.join(",")).join("\n");
    const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `orders_${new Date().toLocaleDateString("ja-JP")}.csv`;
    link.click();
  });
});
</script>

<style>
/* ======== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼å…¨ä½“ ======== */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
}

/* ======== å…¥åŠ›æ¬„ãƒ»ã‚»ãƒ¬ã‚¯ãƒˆå…±é€š ======== */
.filter-bar input,
.filter-bar select {
  border: 2px solid #0dcaf0;
  color: #0dcaf0;
  background: #000814;
  font-weight: 500;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.25s ease;
  box-shadow: 0 0 8px rgba(13, 202, 240, 0.3);
}

.filter-bar input:focus,
.filter-bar select:focus {
  outline: none;
  background: #00182a;
  box-shadow: 0 0 12px rgba(13, 202, 240, 0.8);
}

/* ======== ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ ======== */
.filter-bar input::placeholder {
  color: #0dcaf0b3;
  font-weight: 400;
}

/* ======== ãƒœã‚¿ãƒ³å…±é€š ======== */
.filter-bar button {
  border: 2px solid #0dcaf0;
  color: #0dcaf0;
  background: transparent;
  padding: 8px 18px;
  font-weight: 600;
  border-radius: 6px;
  transition: all 0.25s ease;
  box-shadow: 0 0 6px rgba(13, 202, 240, 0.3);
}

.filter-bar button:hover {
  background: #0dcaf0;
  color: #000;
  box-shadow: 0 0 12px rgba(13, 202, 240, 0.8);
}

/* ======== CSVãƒœã‚¿ãƒ³ç‰¹åˆ¥ã‚«ãƒ©ãƒ¼ ======== */
.filter-bar .csv-btn {
  border-color: #00ff99;
  color: #00ff99;
  box-shadow: 0 0 6px rgba(0, 255, 153, 0.4);
}

.filter-bar .csv-btn:hover {
  background: #00ff99;
  color: #000;
  box-shadow: 0 0 12px rgba(0, 255, 153, 0.8);
}

/* ======== ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ ======== */
@media (max-width: 768px) {
  .filter-bar {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-bar input,
  .filter-bar select,
  .filter-bar button {
    width: 100%;
  }
}
</style>
