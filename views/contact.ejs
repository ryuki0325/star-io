<% title = 'お問い合わせ' %>

<div class="container py-4 text-light">
  <h2 class="mb-4">📩 お問い合わせ</h2>

  <!-- ✅ 成功 / エラーメッセージ -->
  <% if (success) { %>
    <div class="alert alert-success text-center fw-bold" id="msgBox">
      ✅ <%= success %>
    </div>
  <% } else if (error) { %>
    <div class="alert alert-danger text-center fw-bold" id="msgBox">
      ❌ <%= error %>
    </div>
  <% } %>

  <form id="contactForm" action="/contact" method="POST"
        class="bg-dark p-4 rounded border border-info shadow">

    <!-- カテゴリ -->
    <div class="mb-3">
      <label class="form-label fw-bold" aria-label="カテゴリを選択">カテゴリ</label>
      <div class="d-flex gap-2 flex-wrap">
        <% const categories = ["注文","サービス","支払い","その他"]; %>
        <% categories.forEach(cat => { %>
          <button type="button"
                  class="btn btn-outline-info category-btn"
                  data-value="<%= cat %>"><%= cat %></button>
        <% }) %>
      </div>
      <input type="hidden" name="category" id="categoryInput" required>
    </div>

    <!-- サブカテゴリ -->
    <div class="mb-3">
      <label class="form-label fw-bold" aria-label="サブカテゴリを選択">サブカテゴリ</label>
      <div class="d-flex gap-2 flex-wrap">
        <% const subcats = ["保証依頼","キャンセル","スピードアップ","その他"]; %>
        <% subcats.forEach(sub => { %>
          <button type="button"
                  class="btn btn-outline-secondary subcategory-btn"
                  data-value="<%= sub %>"><%= sub %></button>
        <% }) %>
      </div>
      <input type="hidden" name="subcategory" id="subcategoryInput" required>
    </div>

    <!-- 注文ID -->
    <div class="mb-3">
      <label for="orderId" class="form-label fw-bold">注文ID（任意）</label>
      <input type="text" id="orderId" name="orderId"
             class="form-control bg-dark text-light border-info"
             placeholder="例: 123456">
    </div>

    <!-- メールアドレス -->
    <div class="mb-3">
      <label for="email" class="form-label fw-bold">メールアドレス</label>
      <input type="email" id="email" name="email"
             class="form-control bg-dark text-light border-info"
             required placeholder="example@gmail.com">
    </div>

    <!-- 内容 -->
    <div class="mb-3">
      <label for="message" class="form-label fw-bold">お問い合わせ内容</label>
      <textarea id="message" name="message" rows="5"
                class="form-control bg-dark text-light border-info"
                required placeholder="お問い合わせ内容を入力してください..."></textarea>
    </div>

    <button type="submit" class="btn btn-info w-100 fw-bold py-2">送信する</button>
  </form>
</div>

<!-- 🔴 送信できない方用のボタン -->
<div class="mt-3 text-center">
  <button type="button"
          onclick="window.location.href='mailto:star.company527@gmail.com?subject=お問い合わせ（フォーム送信不可）'"
          style="background-color:#dc3545; color:#fff; border:none; padding:10px 16px; border-radius:6px; font-weight:600; cursor:pointer;">
    送信できない方はこちら
  </button>
  <p style="font-size:0.85rem; color:#bbb; margin-top:6px;">
    ※お使いの環境でメールアプリが起動しない場合はこちらをご利用ください
  </p>
</div>

<!-- ✅ スタイル -->
<style>
  .category-btn.active,
  .subcategory-btn.active {
    background-color: #0dcaf0 !important;
    color: #000 !important;
    font-weight: bold;
  }
  #msgBox {
    scroll-margin-top: 80px;
  }
</style>

<!-- ✅ スクリプト -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("📩 お問い合わせフォーム初期化");

  const categoryBtns = document.querySelectorAll(".category-btn");
  const subcategoryBtns = document.querySelectorAll(".subcategory-btn");
  const categoryInput = document.getElementById("categoryInput");
  const subcategoryInput = document.getElementById("subcategoryInput");
  const form = document.getElementById("contactForm");
  const emailInput = document.getElementById("email");
  const orderIdInput = document.getElementById("orderId");
  const messageInput = document.getElementById("message");
  const msgBox = document.getElementById("msgBox");

  if (msgBox) msgBox.scrollIntoView({ behavior: "smooth", block: "center" });

  // ✅ カテゴリ選択
  categoryBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      categoryBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      categoryInput.value = btn.dataset.value;
    });
  });

  // ✅ サブカテゴリ選択
  subcategoryBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      subcategoryBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      subcategoryInput.value = btn.dataset.value;
    });
  });

  // ✅ フォーム送信 → メールアプリを開く
  form.addEventListener("submit", (e) => {
    e.preventDefault(); // 通常のPOSTを止める（メールアプリを優先）

    const category = categoryInput.value.trim();
    const subcategory = subcategoryInput.value.trim();
    const email = emailInput.value.trim();
    const orderId = (orderIdInput.value || "").trim();
    const message = messageInput.value.trim();

    // 入力チェック
    if (!category) { alert("カテゴリを選択してください。"); return; }
    if (!subcategory) { alert("サブカテゴリを選択してください。"); return; }
    if (!email) { alert("メールアドレスを入力してください。"); return; }
    if (!message) { alert("お問い合わせ内容を入力してください。"); return; }

    if (!confirm(`以下の内容でメールアプリを開きます。\n\n📧 ${email}\n🗂 ${category} / ${subcategory}\n🧾 注文ID: ${orderId || "未記入"}\n\nよろしいですか？`)) {
      return;
    }

    // 件名・本文を作成（改行は \r\n）
    const subject = `【${category}/${subcategory}】お問い合わせ（注文ID: ${orderId || "未記入"}）`;
    const lines = [
      "以下の内容でお問い合わせいたします。",
      "",
      `メールアドレス: ${email}`,
      `カテゴリ: ${category}`,
      `サブカテゴリ: ${subcategory}`,
      `注文ID: ${orderId || "未記入"}`,
      "",
      "お問い合わせ内容:",
      message
    ];
    let body = lines.join("\r\n");

    // URL長対策（mailtoは長すぎると失敗するため、本文を短縮）
    const MAX_URL = 1800; // ざっくり安全側
    const enc = (s) => encodeURIComponent(s);
    let mailto = `mailto:star.company527@gmail.com?subject=${enc(subject)}&body=${enc(body)}`;
    if (mailto.length > MAX_URL) {
      // 末尾に追記して本文をカット
      const notice = "\r\n\r\n※本文が長いため一部省略されました。";
      const allow = MAX_URL - (`mailto:star.company527@gmail.com?subject=${enc(subject)}&body=`).length - enc(notice).length - 50;
      // 余裕を持って50文字ぶんマージン
      const cutLen = Math.max(0, body.length - 1);
      while (encodeURIComponent(body).length > allow && body.length > 0) {
        body = body.slice(0, Math.max(0, body.length - 50));
      }
      body += notice;
      mailto = `mailto:star.company527@gmail.com?subject=${enc(subject)}&body=${enc(body)}`;
    }

    // メールアプリを開く
    window.location.href = mailto;

    // 万一開かない環境向けの案内（1秒後に表示）
    setTimeout(() => {
      alert("メールアプリが開かない場合は、画面下の赤いボタン「送信できない方はこちら」から送信してください。");
    }, 1000);
  });
});
</script>
